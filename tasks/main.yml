---
# tasks file for zabbix
- name: install zabbix agent software
  package:
    name: "{{ item }}"
    state: "{{ zabbix_agent | default('present') }}"
  with_items:
    - "{{ zabbix_packages[ansible_distribution]['agent'] }}"
  when:
    - zabbix_agent is defined

- name: install zabbix get software
  package:
    name: "{{ item }}"
    state: "{{ zabbix_get | default('absent') }}"
  with_items:
    - "{{ zabbix_packages[ansible_distribution]['get'] }}"
  when:
    - zabbix_get is defined

- name: install zabbix java_gateway software
  package:
    name: "{{ item }}"
    state: "{{ zabbix_java_gateway | default('absent') }}"
  with_items:
    - "{{ zabbix_packages[ansible_distribution]['java_gateway'] }}"
  when:
    - zabbix_java_gateway is defined

- name: install zabbix server software
  package:
    name: "{{ item }}"
    state: "{{ zabbix_server | default('absent') }}"
  with_items:
    - "{{ zabbix_packages[ansible_distribution]['server'] }}"
  when:
    - zabbix_server is defined

- name: selinux settings for zabbix_server
  seboolean:
    name: "{{ item }}"
    state: yes
    persistent: yes
  with_items:
    - httpd_can_connect_zabbix
    - httpd_can_network_connect_db
  when:
    - ansible_selinux.status is defined
    - ansible_selinux.status == "enabled"
    - zabbix_server is defined

- name: place selinux type enforcement for zabbix server
  copy:
    src: files/my-zabbixserver.te
    dest: /etc/zabbix/my-zabbixserver.te
  notify:
    - create selinux mod
    - create selinux pp
    - load selinux pp
  when:
    - ansible_selinux.status is defined
    - ansible_selinux.status == "enabled"
    - zabbix_server is defined

- name: install zabbix sender software
  package:
    name: "{{ item }}"
    state: "{{ zabbix_sender | default('absent') }}"
  with_items:
    - "{{ zabbix_packages[ansible_distribution]['sender'] }}"
  when:
    - zabbix_sender is defined

- name: install zabbix proxy software
  package:
    name: "{{ item }}"
    state: "{{ zabbix_proxy | default('absent') }}"
  with_items:
    - "{{ zabbix_packages[ansible_distribution]['proxy'] }}"
  when:
    - zabbix_proxy is defined

- name: install zabbix web software
  package:
    name: "{{ item }}"
    state: "{{ zabbix_web | default('absent') }}"
  with_items:
    - "{{ zabbix_packages[ansible_distribution]['web'] }}"
  when:
    - zabbix_web is defined

- name: configuring zabbix agent
  template:
    src: templates/zabbix_agentd.conf.j2
    dest: /etc/zabbix/zabbix_agentd.conf
  notify:
    - restart zabbix agent
  when:
    - zabbix_agent is defined

- name: configure zabbix zabbix server
  template:
    src: templates/zabbix_server.conf.j2
    dest: /etc/zabbix/zabbix_server.conf
  notify:
    - restart zabbix server
  when:
    - zabbix_server is defined

# - name: make configuration directory
#   file:
#     name: /etc/zabbix.d/
#     state: directory
#
# - name: start and enable software
#   service:
#     name: "{{ item }}"
#     state: started
#     enabled: yes
#   with_items:
#     - "{{ zabbix_services[ansible_distribution ~ '-' ~ ansible_distribution_major_version]
#       | default(zabbix_services[ansible_distribution]
#       | default(zabbix_services['default'] )) }}"
#   when:
#     - ansible_virtualization_type != "docker"
